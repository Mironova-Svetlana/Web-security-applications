# Лабораторная работа №2
> Цель работы: Поиск и устранение SQL Injection.

## Выполнили:
> Миронова Светлана Владимировна
 
> Матвиенко Дарья Константиновна

## Задание 1
В папке ``lab2`` находится ``nodejs`` уязвимое приложение. Необходимо развернуть его, найти SQL инъекцию и исправить. Модифицированное приложение загрузить в свой репозиторий GitHub.  

Для выполнения лабораторной потребуется проделать следующие шаги:  
### 1. Для работы были установлены приложения PostgreSQL сервер, где создана БД lib и заполнена данными через запросы SELECT и INSERT, nodejs версии 14 и Visual Studio Code.

   ![20](https://user-images.githubusercontent.com/91056608/149979821-e3917fa0-2f83-4b72-8b5f-513d3a036996.png)
   
   *Выведем данные из таблиц с авторами и книгами:*

   ![21](https://user-images.githubusercontent.com/91056608/149981091-2a4caaf4-2c46-4791-a8a5-1d8f4807ad35.png)

### 2. Через VS Code запустим сайт, где можно увидеть список всех книг и их авторов.
   
   ![22](https://user-images.githubusercontent.com/91056608/149981490-92997ab5-0816-4ee0-bf39-438c4e00c142.jpg)
   
### 3. В коде была обнаружена SQL-инъекция. При написании запроса на проверку пользователя при авторизации были использованы обычные переменные, в которые считывались данные из областей ввода логина и пароля.
   
   ![23](https://user-images.githubusercontent.com/91056608/149981835-10c7f942-e5f8-49a9-a07d-f3764d3aa420.png)

   *При помощи этой уязвимости можно войти на сайт в обход идентификации пользователя. Заметим оператор AND в запросе, который даёт войти в систему лишь при обеих верно введённых переменных. Можно написать любой логин и пароль, добавив истинное значение после написания оператора OR. Пример логина и пароля, под которыми возможно войти в систему приведены на скриншоте ниже.*

   ![24](https://user-images.githubusercontent.com/91056608/149982726-781ca1b2-3408-4c48-ae70-86972d75b40d.png)

   ![25](https://user-images.githubusercontent.com/91056608/149983544-817087ea-8e73-4882-99c2-81c8f9961047.png)

   *Если пользователь допустит ошибку во вводе логина или пароля (например, введёт апостроф после пароля), то программа выдаёт запрос SQL, который не получилось выполнить. Этот проступок со стороны программиста чреват тем, что злоумышленник получает метод шифрования пароля, значит, нетрудно будет получить пароль необходимого пользователя.*

   ![26](https://user-images.githubusercontent.com/91056608/149984079-ad2d5170-bc44-4cc7-80cb-ca299640b7cd.png)

   *Ещё каверзны SQL инъекции тем, что можно узнать пароль пользователя, введя в область пароля на странице входа следующий код: **123') or 1=1 union select (select min(pass) from users) order by 1 asc limit 1--**.*

   ![27](https://user-images.githubusercontent.com/91056608/149984461-384f392b-34b8-483c-bead-8b70b0ff046d.png)

   *Расшифровать пароль можно с помощью онлайн-дешифраторов.*

   ![28](https://user-images.githubusercontent.com/91056608/149984875-ce2f9bde-ea84-4c6d-b970-9cec67b66151.png)
 
### 4. Написать отчёт с описанием найденной уязвимости и примерами её эксплуатации.
#### 4.1. Обход установленного фильтра

   *Проверим возможность обхода установленного фильтра при вводе конструкции с символами комментирования «--»:*

   *Обход фильтра при использовании конструкции:* 
   **2000 ‘ OR 1 = 1 --** .

   ![29](https://user-images.githubusercontent.com/91056608/149985197-724300bd-0709-475f-9802-310ce769fa29.jpg)

   *Какие данные можем взять? Например, версию базы данных и имя пользователя:* 
   **'union select 0,version(), user --**

   ![30](https://user-images.githubusercontent.com/91056608/149985507-fd8e9c52-3b7d-46cb-b927-aeb85de1a865.jpg)

   *Получим имена таблиц и колонок базы данных, включая системные:* 
   **'union select 0,table_name, column_name from information_schema.columns --**

   ![32](https://user-images.githubusercontent.com/91056608/149985918-1a31a0bd-87ad-4696-b5f0-97dbfd323825.png)

   ![33](https://user-images.githubusercontent.com/91056608/149986534-74aefd0c-413c-447c-9417-50e50028d1c4.jpg)
   
   #### 4.2. Получение данных из другой таблицы 

   *Получим данные из таблицы book:* 
   **'union select id, name, null from book--**

   ![34](https://user-images.githubusercontent.com/91056608/149986920-d24923cd-caf3-4daf-8ba1-70f9f06afabc.png)
   
   *Найдем информацию о таблице users: Видим, что таблица users имеет два столбца, pass и name с текстовым типом данных:* 
   **'union select 0, column_name, data_type from information_schema.columns where table_name = 'users'--**

   ![35](https://user-images.githubusercontent.com/91056608/149987174-091cbc72-8f3e-4ed4-94cb-8ac055045a6b.png)
   
   #### 4.3. Похищение пароля пользователя

   *Похитим пароль пользователя:*
   **'union select 0, name, pass from public.users--**

   ![36](https://user-images.githubusercontent.com/91056608/149987371-730faf77-bba8-4001-9b4b-b9afa322ab7b.png)

### 5. Исправить уязвимость
   
   ![37](https://user-images.githubusercontent.com/91056608/149987674-40c57ec9-a2f2-40d8-bd47-e5f88071e4f1.png)

   ![38](https://user-images.githubusercontent.com/91056608/149987793-aba72d00-42dc-4b6c-b18c-bb963a01cea4.png)

   *Уязвимость можно избежать, если не использовать конкатенацию строк и не вставлять переменные в запросы напрямую. Вместо этого можно использовать параметризованные запросы, где объекты передаются через $ и указание необходимые переменных в квадратных скобках при передаче.*

   ![39](https://user-images.githubusercontent.com/91056608/149988009-7a48c154-181e-4add-a342-7b27c505911d.png)

Полезные ссылки
1. lecture 4 (sql-Injection).pptx
2. https://nodejs.org/en/docs/guides/getting-started-guide/
3. https://pugjs.org/api/getting-started.html